# RFC 001: Albion Market Data Ingestion Service

| Metadata | Value |
| :--- | :--- |
| **Author** | [Your Name/Dev Team] |
| **Status** | Draft |
| **Created** | 2023-10-27 |
| **Target** | Albion Online Data Project (AODP) v2 API |

## 1. Введение (Abstract)
Этот документ описывает архитектуру сервиса `Ingestor`, предназначенного для автоматического сбора, валидации и сохранения рыночных цен из API Albion Online. Сервис работает в фоновом режиме, обновляя цены для приоритетных предметов.

## 2. Мотивация (Motivation)
Текущая система требует ручного обновления или не имеет актуальных данных для крафт-калькулятора. Нам необходимо:
* Автоматически поддерживать актуальность цен (не старше 1 часа).
* Соблюдать жесткие лимиты API AODP (Rate Limiting).
* Собирать историю цен для аналитики.

## 3. Технический Дизайн (Technical Design)

### 3.1. Компоненты
1.  **Worker (Orchestrator):** Бесконечный цикл, управляющий выборкой задач и паузами.
2.  **Repository Layer:** Изолирует работу с БД (SQLAlchemy).
3.  **API Client Layer:** Изолирует работу с сетью (httpx) и обработку ошибок 429/5xx.
4.  **Database:** Использует таблицы `tracked_items` (очередь), `market_prices` (снэпшот), `market_history` (временной ряд).

### 3.2. Алгоритм работы (Workflow)
1.  **Fetch:** Выбрать из БД 500 записей `tracked_items`, у которых `last_check` > 1 часа или NULL. Сортировка по `priority`.
2.  **Batch:** Разбить задачи на пачки по 40-45 предметов (ограничение длины URL).
3.  **Request:** Сформировать GET запрос: `/prices/{ids}?locations={locs}&qualities=1,2,3,4,5`.
4.  **Validation:** Проверить ответ через Pydantic схему.
5.  **Upsert:** * Обновить `market_prices` (текущая цена).
    * Добавить запись в `market_history` (история).
    * Обновить `tracked_items.last_check = NOW()`.
6.  **Sleep:** Пауза 2.1 сек между запросами (Safety buffer для лимита 1 req/sec).

### 3.3. Обработка ошибок и ограничений
* **HTTP 429 (Too Many Requests):** Воркер засыпает на 60 секунд.
* **HTTP 5xx/Timeout:** Пропуск текущего батча, логирование ошибки, продолжение работы.
* **Empty Response:** Обновляем `last_check` даже если данных нет, чтобы не зацикливаться на "пустых" предметах.

## 4. Схема данных (Data Schema)
Используются существующие модели `TrackedItem`, `MarketPrice`, `MarketHistory`.
*Ключевое решение:* Составной первичный ключ `(item_id, location_id, quality_level)` для цен.

## 5. Альтернативы
* *Websockets:* AODP предоставляет NATS/Websocket стрим ("firehose").
    * *Минусы:* Огромный объем трафика, данные "сырые", нужно фильтровать гигабайты ненужной информации.
    * *Решение:* Отказаться в пользу REST API (Polling), так как нам нужны конкретные предметы, а не всё подряд.

## 6. Вопросы и Риски
* **Риск:** Изменение API AODP v2. -> Решение: Изоляция в `AlbionUrlBuilder`.
* **Риск:** Рост базы `market_history`. -> Решение: В будущем внедрить партицирование таблицы по месяцам.