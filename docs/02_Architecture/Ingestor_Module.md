# Ingestor Module Architecture

## Назначение
Модуль `src/ingesting` отвечает за получение данных из внешнего Albion Data API, их первичную обработку, валидацию и сохранение в базу данных. Модуль спроектирован для работы в асинхронном режиме с поддержкой конкурентности и ограничения частоты запросов (Rate Limiting).

## Ключевые компоненты

### 1. IngestorService (`src/ingesting/service.py`)
Центральный класс-оркестратор. Реализует паттерн **Facade** для процесса обновления данных.

**Ответственности:**
* **Управление кэшем:** Загружает маппинг `api_name -> location_id` при старте.
* **Batching (Пакетирование):** Разбивает список запрашиваемых предметов (`items`) на пакеты (батчи) размером `config.batch_size` (согласно SC-04).
* **Concurrency Control:** Использует `asyncio.Semaphore` для ограничения количества одновременных "летящих" запросов к API (`config.concurrency`).
* **Rate Limiting:** Использует `AsyncLimiter` (глобальный или локальный) для соблюдения лимитов API перед выполнением запроса.

### 2. Зависимости (DI)
Сервис зависит от абстракций (Interfaces), что соответствует DIP (Dependency Inversion Principle):

* `IAlbionApiClient`: Абстракция клиента API. Позволяет подменять реальный HTTP-клиент на мок в тестах.
* `IIngestorRepository`: Слой доступа к данным (Repository Pattern). Отвечает за сохранение результатов пакета в БД.
* `PriceProcessor`: Компонент бизнес-логики. Преобразует сырые DTO от API в доменные модели (фильтрация, нормализация цен).

## Поток данных (Data Flow)

Процесс обработки одной локации (`_process_location`):

1.  **Validation:** Проверка наличия локации во внутреннем кэше.
2.  **Batching:** Список предметов нарезается на чанки (например, по 50 штук).
3.  **Scheduling:** Для каждого чанка создается асинхронная задача `_process_batch`.
4.  **Execution (внутри `_process_batch`):**
    * **Wait:** Ожидание токена от Rate Limiter.
    * **Fetch:** Асинхронный HTTP запрос (`client.fetch_prices`).
    * **Process:** Преобразование данных (`processor.process`).
    * **Persist:** Сохранение в транзакции (`repository.save_batch_results`).

## Конфигурация
Поведение регулируется через `IngestorConfig`:
* `max_rate`: Лимит запросов в секунду.
* `batch_size`: Количество предметов в одном запросе.
* `concurrency`: Максимальное число параллельных корутин.