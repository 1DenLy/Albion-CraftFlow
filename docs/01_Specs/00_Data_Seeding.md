# Спецификация: Модуль Initial Seeding

## 1. Назначение
Модуль `src/scripts/seed_db.py` отвечает за первоначальное наполнение базы данных статическими справочниками. Без выполнения этого этапа работа сервиса `Ingestor` невозможна (ошибки Foreign Key).

## 2. Источники данных
* **Locations:** Хардкод список основных городов (Martlock, Lymhurst и т.д.) внутри скрипта.
* **Items:** Внешний JSON-файл из репозитория [ao-bin-dumps](https://github.com/ao-data/ao-bin-dumps).
    * URL: `https://raw.githubusercontent.com/ao-bin-dumps/formatted/master/items.json`

## 3. Алгоритм работы

### 3.1. Этап проверки (Pre-flight Check)
Скрипт проверяет количество записей в таблицах `locations` и `items` используя быстрый запрос `SELECT COUNT`.
* Если данные есть (`count > 0` для локаций, `count > 1000` для предметов) — выполнение пропускается.
* Это обеспечивает **идемпотентность** запуска.

### 3.2. Этап загрузки (Extract)
* Используется библиотека `httpx`.
* Таймаут увеличен до 60 секунд (файл предметов может быть большим).
* При ошибке сети скрипт завершает работу с логированием `CRITICAL`.

### 3.3. Этап трансформации (Transform)
Сырой JSON преобразуется в плоскую структуру для БД.
* **Parsing Name:** Из `UniqueName` (например, `T4_MAIN_SWORD@1`) извлекаются:
    * `tier`: 4
    * `base_name`: `MAIN_SWORD`
    * `enchantment`: 1
* **Filtering:** Игнорируются предметы с пометками `TEST`, `TUTORIAL` или без `UniqueName`.

### 3.4. Этап загрузки (Load)
Используется **SQLAlchemy Core** для максимальной производительности.
* Данные разбиваются на чанки (Chunk Size: 5000).
* Выполняется `bulk insert`.

## 4. Обслуживание
При изменении структуры API Albion Data Project или формата файла `items.json`:
1. Изменить функцию `parse_item_dict`.
2. Очистить таблицу `items` (`TRUNCATE items CASCADE`).
3. Перезапустить скрипт.